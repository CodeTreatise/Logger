# 1.2.1 Troubleshooting and Debugging

## The Critical Role of Logging in Problem Resolution

Troubleshooting and debugging are fundamental activities in backend development, and logging serves as the primary mechanism for understanding what went wrong, when, and why.

## Why Traditional Debugging Falls Short in Production

### Development vs Production Environments
- **Development**: Direct access to debuggers, IDE tools, and real-time inspection
- **Production**: No debugger access, remote systems, and performance constraints
- **Logging bridges this gap** by providing persistent, accessible information

### Limitations of Interactive Debugging in Backend Systems
```javascript
// ❌ This doesn't work in production
debugger; // Stops execution
console.log("Debug info"); // Not persistent or structured

// ✅ This provides persistent troubleshooting data
logger.error('Database connection failed', {
  error: err.message,
  stack: err.stack,
  connectionString: sanitizedConnectionString,
  retryAttempt: attempt,
  timestamp: new Date().toISOString()
});
```

## Logging for Effective Troubleshooting

### 1. **Error Context and Stack Traces**
```javascript
// Comprehensive error logging
try {
  await processUserOrder(orderId, userId);
} catch (error) {
  logger.error('Order processing failed', {
    orderId,
    userId,
    error: {
      message: error.message,
      stack: error.stack,
      code: error.code
    },
    orderDetails: {
      items: order.items.length,
      totalAmount: order.total,
      paymentMethod: order.paymentMethod
    },
    systemState: {
      memoryUsage: process.memoryUsage(),
      uptime: process.uptime()
    }
  });
  throw error;
}
```

### 2. **Request Flow Tracking**
```javascript
// Trace request through multiple components
app.use((req, res, next) => {
  const requestId = req.headers['x-request-id'] || generateId();
  req.logger = logger.child({ requestId });
  
  req.logger.info('Request started', {
    method: req.method,
    url: req.url,
    userAgent: req.get('User-Agent'),
    ip: req.ip
  });
  
  next();
});

// In business logic
async function processPayment(paymentData, logger) {
  logger.info('Payment processing started', { amount: paymentData.amount });
  
  try {
    const result = await paymentGateway.charge(paymentData);
    logger.info('Payment successful', { transactionId: result.id });
    return result;
  } catch (error) {
    logger.error('Payment failed', { 
      error: error.message,
      paymentData: sanitize(paymentData) 
    });
    throw error;
  }
}
```

### 3. **State Change Documentation**
```javascript
// Log important state transitions
class OrderStateMachine {
  async transition(orderId, fromState, toState, reason) {
    logger.info('Order state transition', {
      orderId,
      fromState,
      toState,
      reason,
      timestamp: new Date().toISOString(),
      triggeredBy: this.getCurrentUser()
    });
    
    try {
      await this.updateOrderState(orderId, toState);
      logger.info('State transition completed', { orderId, newState: toState });
    } catch (error) {
      logger.error('State transition failed', {
        orderId,
        attemptedTransition: `${fromState} -> ${toState}`,
        error: error.message
      });
      throw error;
    }
  }
}
```

## Common Troubleshooting Scenarios

### 1. **Performance Issues**
```javascript
// Log performance metrics for troubleshooting
const performanceLogger = logger.child({ component: 'performance' });

async function handleDatabaseQuery(query, params) {
  const startTime = Date.now();
  
  try {
    const result = await database.query(query, params);
    const duration = Date.now() - startTime;
    
    performanceLogger.info('Query executed', {
      query: query.substring(0, 100), // Truncate for readability
      paramCount: params.length,
      resultCount: result.length,
      duration,
      slow: duration > 1000 // Flag slow queries
    });
    
    return result;
  } catch (error) {
    performanceLogger.error('Query failed', {
      query,
      params: sanitizeParams(params),
      duration: Date.now() - startTime,
      error: error.message
    });
    throw error;
  }
}
```

### 2. **Integration Failures**
```javascript
// External service call logging
async function callExternalAPI(endpoint, data) {
  const correlationId = generateCorrelationId();
  
  logger.info('External API call initiated', {
    endpoint,
    correlationId,
    dataSize: JSON.stringify(data).length
  });
  
  try {
    const response = await httpClient.post(endpoint, data, {
      headers: { 'X-Correlation-ID': correlationId }
    });
    
    logger.info('External API call successful', {
      endpoint,
      correlationId,
      statusCode: response.status,
      responseSize: response.data ? JSON.stringify(response.data).length : 0
    });
    
    return response.data;
  } catch (error) {
    logger.error('External API call failed', {
      endpoint,
      correlationId,
      error: {
        message: error.message,
        code: error.code,
        response: error.response?.data
      },
      retryable: isRetryableError(error)
    });
    throw error;
  }
}
```

### 3. **Concurrency Issues**
```javascript
// Log concurrent operations
class ResourceManager {
  constructor() {
    this.locks = new Map();
    this.logger = logger.child({ component: 'ResourceManager' });
  }
  
  async acquireLock(resourceId, operation) {
    this.logger.debug('Lock acquisition attempt', {
      resourceId,
      operation,
      currentLocks: this.locks.size,
      waitingThreads: this.getWaitingCount(resourceId)
    });
    
    if (this.locks.has(resourceId)) {
      this.logger.warn('Resource already locked', {
        resourceId,
        operation,
        currentOperation: this.locks.get(resourceId),
        waitTime: Date.now()
      });
    }
    
    // Lock acquisition logic...
    this.logger.info('Lock acquired', { resourceId, operation });
  }
}
```

## Best Practices for Troubleshooting-Focused Logging

### 1. **Log at Decision Points**
```javascript
// Log important business logic decisions
function calculateShippingCost(order, destination) {
  logger.debug('Calculating shipping cost', {
    orderId: order.id,
    itemCount: order.items.length,
    weight: order.totalWeight,
    destination: destination.country
  });
  
  if (order.totalWeight > MAX_WEIGHT) {
    logger.warn('Heavy order detected', {
      orderId: order.id,
      weight: order.totalWeight,
      maxWeight: MAX_WEIGHT,
      shippingMethod: 'freight'
    });
    return calculateFreightShipping(order, destination);
  }
  
  if (destination.country === 'international') {
    logger.info('International shipping calculation', {
      orderId: order.id,
      destination: destination.country
    });
    return calculateInternationalShipping(order, destination);
  }
  
  // Standard shipping logic...
}
```

### 2. **Include Sufficient Context**
```javascript
// Rich contextual information
logger.error('User authentication failed', {
  // What happened
  event: 'authentication_failure',
  
  // When it happened
  timestamp: new Date().toISOString(),
  
  // Who was involved
  userIdentifier: user.email,
  userRole: user.role,
  
  // Where it happened
  endpoint: req.path,
  userAgent: req.get('User-Agent'),
  ip: req.ip,
  
  // Why it failed
  reason: 'invalid_password',
  attemptNumber: user.failedAttempts + 1,
  
  // System state
  serverLoad: process.cpuUsage(),
  memoryUsage: process.memoryUsage()
});
```

### 3. **Use Correlation IDs**
```javascript
// Track requests across service boundaries
const express = require('express');
const { v4: uuidv4 } = require('uuid');

app.use((req, res, next) => {
  req.correlationId = req.headers['x-correlation-id'] || uuidv4();
  res.setHeader('X-Correlation-ID', req.correlationId);
  req.logger = logger.child({ correlationId: req.correlationId });
  next();
});

// Now all logs within this request include the correlation ID
req.logger.info('Processing user registration');
// This makes it easy to find all logs related to a specific request
```

## Troubleshooting Workflow with Logs

### 1. **Identify the Problem**
- Search logs for error patterns
- Filter by time range when issue occurred
- Look for correlation IDs or user identifiers

### 2. **Trace the Execution Path**
- Follow log entries chronologically
- Identify where normal flow diverged
- Look for missing expected log entries

### 3. **Analyze Context**
- Examine system state at time of error
- Check resource usage and external dependencies
- Review concurrent operations

### 4. **Reproduce and Verify**
- Use log insights to reproduce issue
- Add additional logging if needed
- Verify fix effectiveness through logs

## Tools and Techniques

### Log Analysis Commands
```bash
# Find errors in specific time range
grep "ERROR" app.log | grep "2025-08-18 10:"

# Follow correlation ID across logs
grep "correlation-123456" *.log

# Count error types
grep "ERROR" app.log | awk '{print $4}' | sort | uniq -c

# Monitor real-time issues
tail -f app.log | grep "ERROR\|WARN"
```

### Structured Query Examples
```javascript
// Elasticsearch query for troubleshooting
{
  "query": {
    "bool": {
      "must": [
        { "term": { "level": "ERROR" } },
        { "range": { "timestamp": { "gte": "2025-08-18T10:00:00" } } },
        { "term": { "correlationId": "req-123456" } }
      ]
    }
  },
  "sort": [{ "timestamp": "asc" }]
}
```

## Measuring Troubleshooting Effectiveness

### Key Metrics
- **Mean Time to Detection (MTTD)**: How quickly issues are identified
- **Mean Time to Resolution (MTTR)**: How quickly issues are resolved
- **Root Cause Analysis Success Rate**: Percentage of issues with identified root cause
- **Log Coverage**: Percentage of system components with adequate logging

### Improvement Strategies
- Regular log reviews to identify gaps
- Post-incident analysis to improve logging
- Automated log analysis and alerting
- Team training on log analysis techniques

---

**Previous**: [1.1.3 Historical Context and Evolution](../1.1_What_is_Logging/1.1.3_Historical_Context_and_Evolution.md)  
**Next**: [1.2.2 Monitoring Application Health](./1.2.2_Monitoring_Application_Health.md)
