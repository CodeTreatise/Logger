# 1.3.2 User Actions

## Understanding User Action Logging

User action logging captures the interactions and behaviors of users within your backend application. This type of logging is crucial for understanding user patterns, detecting security issues, meeting compliance requirements, and improving user experience through behavioral analysis.

## Categories of User Actions

### 1. **Authentication and Session Management**
Tracking user authentication events, session lifecycle, and access patterns.

```javascript
// User authentication logging
class UserAuthenticationLogger {
  constructor(logger) {
    this.logger = logger.child({ component: 'user-auth' });
    this.failedAttempts = new Map(); // Track failed attempts per user
    this.suspiciousActivity = new Set(); // Track suspicious IPs
  }
  
  logLoginAttempt(loginData, result, context) {
    const loginEvent = {
      eventType: 'user_login_attempt',
      timestamp: new Date().toISOString(),
      
      // User identification (be careful with PII)
      userId: result.success ? result.userId : null,
      username: this.hashUsername(loginData.username), // Hash for privacy
      
      // Authentication details
      authMethod: loginData.authMethod, // 'password', 'oauth', 'sso', '2fa'
      authProvider: loginData.provider, // 'local', 'google', 'github', etc.
      
      // Login result
      success: result.success,
      failureReason: result.success ? null : result.failureReason,
      
      // Session information
      sessionId: result.sessionId,
      sessionTimeout: result.sessionTimeout,
      
      // Request context
      sourceIP: context.ip,
      userAgent: context.userAgent,
      deviceFingerprint: context.deviceFingerprint,
      
      // Geolocation (if available)
      country: context.geoLocation?.country,
      city: context.geoLocation?.city,
      timezone: context.timezone,
      
      // Security analysis
      riskScore: this.calculateRiskScore(loginData, context),
      newDevice: this.isNewDevice(loginData.username, context.deviceFingerprint),
      newLocation: this.isNewLocation(loginData.username, context.geoLocation),
      
      // Rate limiting
      recentFailures: this.getRecentFailures(loginData.username),
      timeFromLastAttempt: this.getTimeFromLastAttempt(loginData.username),
      
      // Additional security flags
      vpnDetected: context.vpnDetected,
      proxyDetected: context.proxyDetected,
      suspiciousUserAgent: this.isSuspiciousUserAgent(context.userAgent)
    };
    
    // Update failed attempts tracking
    if (!result.success) {
      this.trackFailedAttempt(loginData.username, context.ip);
    } else {
      this.clearFailedAttempts(loginData.username);
    }
    
    // Log with appropriate level
    if (result.success) {
      if (loginEvent.riskScore > 0.7) {
        this.logger.warn('High-risk login successful', loginEvent);
      } else {
        this.logger.info('User login successful', loginEvent);
      }
    } else {
      this.logger.warn('User login failed', loginEvent);
    }
    
    // Trigger alerts for suspicious activity
    if (loginEvent.riskScore > 0.8 || loginEvent.recentFailures > 5) {
      this.triggerSecurityAlert(loginEvent);
    }
  }
  
  logUserLogout(user, sessionData, context) {
    const logoutEvent = {
      eventType: 'user_logout',
      timestamp: new Date().toISOString(),
      
      // User information
      userId: user.id,
      username: this.hashUsername(user.username),
      userRole: user.role,
      
      // Session details
      sessionId: sessionData.sessionId,
      sessionDuration: Date.now() - sessionData.startTime,
      
      // Logout details
      logoutType: context.logoutType, // 'user_initiated', 'timeout', 'forced', 'system'
      logoutReason: context.reason,
      
      // Activity summary
      actionsPerformed: sessionData.actionsCount,
      pagesVisited: sessionData.pagesVisited,
      dataModified: sessionData.dataModified,
      
      // Security context
      sourceIP: context.ip,
      finalLocation: context.location,
      
      // Session quality metrics
      errorsEncountered: sessionData.errorsCount,
      warningsGenerated: sessionData.warningsCount,
      performanceIssues: sessionData.performanceIssues
    };
    
    this.logger.info('User logout', logoutEvent);
  }
  
  logPasswordChange(user, changeDetails, context) {
    const passwordChangeEvent = {
      eventType: 'password_change',
      timestamp: new Date().toISOString(),
      
      // User information
      userId: user.id,
      userRole: user.role,
      
      // Change details
      changeType: changeDetails.type, // 'user_initiated', 'admin_forced', 'expired', 'breach_response'
      changeReason: changeDetails.reason,
      
      // Security validation
      oldPasswordVerified: changeDetails.oldPasswordVerified,
      passwordStrengthScore: changeDetails.strengthScore,
      passwordReused: changeDetails.reusedPassword,
      
      // Context information
      sourceIP: context.ip,
      userAgent: context.userAgent,
      sessionId: context.sessionId,
      
      // Security measures
      twoFactorUsed: changeDetails.twoFactorUsed,
      securityQuestionsAnswered: changeDetails.securityQuestionsAnswered,
      
      // Administrative context
      adminInitiated: changeDetails.adminInitiated,
      adminUserId: changeDetails.adminUserId,
      complianceRequired: changeDetails.complianceRequired
    };
    
    this.logger.warn('User password changed', passwordChangeEvent);
    
    // Alert on suspicious password changes
    if (changeDetails.type === 'admin_forced' || !changeDetails.oldPasswordVerified) {
      this.logger.error('Suspicious password change detected', passwordChangeEvent);
    }
  }
}
```

### 2. **Data Access and Manipulation**
Tracking user interactions with data, including viewing, editing, creating, and deleting records.

```javascript
// User data interaction logging
class UserDataActionLogger {
  constructor(logger, dataClassifier) {
    this.logger = logger.child({ component: 'user-data-actions' });
    this.dataClassifier = dataClassifier;
  }
  
  logDataAccess(user, resource, accessDetails, context) {
    const dataAccessEvent = {
      eventType: 'user_data_access',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      username: user.username,
      userRole: user.role,
      userDepartment: user.department,
      
      // Resource information
      resourceType: resource.type,
      resourceId: resource.id,
      resourceOwner: resource.owner,
      resourcePath: resource.path,
      
      // Access details
      accessType: accessDetails.type, // 'view', 'download', 'export', 'print'
      accessMethod: accessDetails.method, // 'web', 'api', 'mobile'
      accessReason: accessDetails.reason,
      
      // Data classification
      dataClassification: this.dataClassifier.classify(resource.data),
      sensitivityLevel: resource.sensitivityLevel,
      complianceRelevant: resource.complianceFrameworks,
      
      // Access context
      requestId: context.requestId,
      sessionId: context.sessionId,
      sourceIP: context.ip,
      userAgent: context.userAgent,
      
      // Data volume
      recordCount: Array.isArray(resource.data) ? resource.data.length : 1,
      dataSize: this.calculateDataSize(resource.data),
      
      // Authorization
      permissionLevel: accessDetails.permissionLevel,
      authorizationPath: accessDetails.authorizationPath,
      dataMinimization: accessDetails.dataMinimization,
      
      // Business context
      businessPurpose: accessDetails.businessPurpose,
      projectContext: accessDetails.projectContext,
      customerImpact: accessDetails.customerImpact
    };
    
    // Log based on data sensitivity
    if (dataAccessEvent.sensitivityLevel === 'high' || dataAccessEvent.complianceRelevant.length > 0) {
      this.logger.warn('Sensitive data accessed', dataAccessEvent);
    } else {
      this.logger.info('Data accessed', dataAccessEvent);
    }
    
    // Track bulk access patterns
    if (dataAccessEvent.recordCount > 1000) {
      this.logger.warn('Bulk data access detected', {
        ...dataAccessEvent,
        bulkAccessAlert: true,
        bulkAccessThreshold: 1000
      });
    }
  }
  
  logDataModification(user, resource, changeDetails, context) {
    const modificationEvent = {
      eventType: 'user_data_modification',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      userRole: user.role,
      
      // Resource information
      resourceType: resource.type,
      resourceId: resource.id,
      
      // Modification details
      modificationType: changeDetails.type, // 'create', 'update', 'delete', 'bulk_update'
      fieldsModified: changeDetails.fieldsModified,
      recordsAffected: changeDetails.recordsAffected,
      
      // Change tracking
      oldValues: this.sanitizeValues(changeDetails.oldValues),
      newValues: this.sanitizeValues(changeDetails.newValues),
      changeReason: changeDetails.reason,
      
      // Validation and approval
      validationPassed: changeDetails.validationPassed,
      approvalRequired: changeDetails.approvalRequired,
      approvedBy: changeDetails.approvedBy,
      
      // Context information
      requestId: context.requestId,
      sourceIP: context.ip,
      userAgent: context.userAgent,
      
      // Business impact
      businessImpact: changeDetails.businessImpact,
      customerAffected: changeDetails.customerAffected,
      
      // Audit trail
      auditTrailId: changeDetails.auditTrailId,
      complianceValidation: changeDetails.complianceValidation,
      dataRetentionImpact: changeDetails.dataRetentionImpact
    };
    
    if (changeDetails.type === 'delete' || modificationEvent.recordsAffected > 100) {
      this.logger.warn('Significant data modification', modificationEvent);
    } else {
      this.logger.info('Data modified', modificationEvent);
    }
    
    // Alert on unauthorized changes
    if (!changeDetails.validationPassed || (changeDetails.approvalRequired && !changeDetails.approvedBy)) {
      this.logger.error('Unauthorized data modification attempt', modificationEvent);
    }
  }
  
  logFileUpload(user, fileDetails, uploadResult, context) {
    const fileUploadEvent = {
      eventType: 'user_file_upload',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      userRole: user.role,
      
      // File information
      fileName: fileDetails.originalName,
      fileSize: fileDetails.size,
      fileType: fileDetails.mimeType,
      fileExtension: fileDetails.extension,
      
      // Upload details
      uploadMethod: context.uploadMethod, // 'web_form', 'api', 'drag_drop'
      uploadDestination: uploadResult.destination,
      uploadSuccess: uploadResult.success,
      
      // Security scanning
      virusScanResult: uploadResult.virusScan,
      malwareDetected: uploadResult.malwareDetected,
      contentValidation: uploadResult.contentValidation,
      
      // File processing
      thumbnailGenerated: uploadResult.thumbnailGenerated,
      metadataExtracted: uploadResult.metadataExtracted,
      indexingCompleted: uploadResult.indexingCompleted,
      
      // Access control
      filePermissions: uploadResult.permissions,
      shareSettings: uploadResult.shareSettings,
      expirationDate: uploadResult.expirationDate,
      
      // Context information
      requestId: context.requestId,
      sourceIP: context.ip,
      userAgent: context.userAgent,
      
      // Business context
      projectAssociation: context.projectId,
      businessPurpose: context.businessPurpose
    };
    
    if (uploadResult.success) {
      this.logger.info('File uploaded successfully', fileUploadEvent);
    } else {
      this.logger.error('File upload failed', fileUploadEvent);
    }
    
    // Security alerts
    if (uploadResult.malwareDetected || !uploadResult.contentValidation) {
      this.logger.error('Potentially malicious file upload detected', fileUploadEvent);
    }
  }
}
```

### 3. **Navigation and User Journey**
Tracking user navigation patterns, page views, and user journey through the application.

```javascript
// User navigation logging
class UserNavigationLogger {
  constructor(logger) {
    this.logger = logger.child({ component: 'user-navigation' });
    this.userSessions = new Map(); // Track user sessions
  }
  
  logPageView(user, pageDetails, context) {
    const pageViewEvent = {
      eventType: 'user_page_view',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      userRole: user.role,
      sessionId: context.sessionId,
      
      // Page information
      pagePath: pageDetails.path,
      pageTitle: pageDetails.title,
      pageCategory: pageDetails.category,
      pageLoadTime: pageDetails.loadTime,
      
      // Navigation context
      referrerPage: context.referrer,
      navigationMethod: context.navigationMethod, // 'direct', 'link', 'back_button', 'bookmark'
      
      // User journey
      visitNumber: this.getVisitNumber(user.id, context.sessionId),
      timeOnPreviousPage: this.getTimeOnPreviousPage(user.id),
      pagesViewedInSession: this.getPagesInSession(context.sessionId),
      
      // Technical context
      userAgent: context.userAgent,
      screenResolution: context.screenResolution,
      deviceType: context.deviceType, // 'desktop', 'mobile', 'tablet'
      
      // Performance metrics
      domContentLoaded: pageDetails.domContentLoaded,
      pageFullyLoaded: pageDetails.pageFullyLoaded,
      timeToFirstByte: pageDetails.timeToFirstByte,
      
      // Content interaction
      elementsOnPage: pageDetails.elementCount,
      formsOnPage: pageDetails.formCount,
      linksOnPage: pageDetails.linkCount
    };
    
    this.logger.info('User page view', pageViewEvent);
    
    // Track user session
    this.updateUserSession(user.id, context.sessionId, pageDetails);
    
    // Performance alerts
    if (pageDetails.loadTime > 5000) {
      this.logger.warn('Slow page load detected', {
        ...pageViewEvent,
        performanceAlert: true,
        slowLoadThreshold: 5000
      });
    }
  }
  
  logUserAction(user, actionDetails, context) {
    const userActionEvent = {
      eventType: 'user_interface_action',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      sessionId: context.sessionId,
      
      // Action details
      actionType: actionDetails.type, // 'click', 'form_submit', 'scroll', 'hover', 'focus'
      elementType: actionDetails.elementType, // 'button', 'link', 'form', 'input'
      elementId: actionDetails.elementId,
      elementText: actionDetails.elementText,
      elementClass: actionDetails.elementClass,
      
      // Page context
      pagePath: context.pagePath,
      pageSection: actionDetails.pageSection,
      
      // Action context
      mousePosition: actionDetails.mousePosition,
      scrollPosition: actionDetails.scrollPosition,
      timeOnPage: actionDetails.timeOnPage,
      
      // Form details (if applicable)
      formId: actionDetails.formId,
      formFields: actionDetails.formFields,
      formValidation: actionDetails.formValidation,
      
      // Business context
      featureUsed: actionDetails.feature,
      workflowStep: actionDetails.workflowStep,
      goalCompleted: actionDetails.goalCompleted,
      
      // A/B testing context
      experimentId: context.experimentId,
      variationId: context.variationId,
      
      // Performance metrics
      actionResponseTime: actionDetails.responseTime,
      networkLatency: actionDetails.networkLatency
    };
    
    this.logger.info('User interface action', userActionEvent);
    
    // Track feature usage
    if (actionDetails.goalCompleted) {
      this.logger.info('User goal completed', {
        ...userActionEvent,
        goalCompletionEvent: true
      });
    }
  }
  
  logSearchAction(user, searchDetails, results, context) {
    const searchEvent = {
      eventType: 'user_search',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      sessionId: context.sessionId,
      
      // Search details
      searchQuery: searchDetails.query,
      searchType: searchDetails.type, // 'basic', 'advanced', 'filter'
      searchCategory: searchDetails.category,
      
      // Search parameters
      filters: searchDetails.filters,
      sortCriteria: searchDetails.sortBy,
      dateRange: searchDetails.dateRange,
      
      // Results information
      totalResults: results.total,
      resultsShown: results.shown,
      resultPages: results.pages,
      searchTime: results.executionTime,
      
      // User interaction with results
      resultsClicked: results.clicked,
      resultsBookmarked: results.bookmarked,
      searchRefined: results.refined,
      
      // Search quality metrics
      zeroResults: results.total === 0,
      searchAbandoned: results.abandoned,
      searchSatisfaction: results.satisfaction,
      
      // Context information
      pagePath: context.pagePath,
      previousSearch: this.getPreviousSearch(user.id),
      
      // Business intelligence
      searchIntent: this.categorizeSearchIntent(searchDetails.query),
      businessValue: this.assessSearchBusinessValue(searchDetails, results)
    };
    
    this.logger.info('User search performed', searchEvent);
    
    // Alert on problematic searches
    if (results.total === 0 || results.executionTime > 5000) {
      this.logger.warn('Search performance issue', searchEvent);
    }
  }
}
```

### 4. **Business Operations and Transactions**
Tracking user-initiated business operations and transactions.

```javascript
// User business operations logging
class UserBusinessOperationLogger {
  constructor(logger) {
    this.logger = logger.child({ component: 'user-business-ops' });
  }
  
  logBusinessTransaction(user, transaction, result, context) {
    const transactionEvent = {
      eventType: 'user_business_transaction',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      userRole: user.role,
      userDepartment: user.department,
      
      // Transaction details
      transactionId: transaction.id,
      transactionType: transaction.type,
      transactionCategory: transaction.category,
      transactionValue: transaction.value,
      
      // Business context
      businessProcess: transaction.businessProcess,
      workflowInstanceId: transaction.workflowInstanceId,
      approvalRequired: transaction.approvalRequired,
      
      // Transaction participants
      initiatedBy: user.id,
      approvedBy: transaction.approvedBy,
      beneficiaries: transaction.beneficiaries,
      
      // Financial details (if applicable)
      amount: transaction.amount,
      currency: transaction.currency,
      accountsAffected: transaction.accountsAffected,
      
      // Result information
      success: result.success,
      transactionReference: result.reference,
      confirmationNumber: result.confirmationNumber,
      
      // Risk assessment
      riskScore: result.riskScore,
      fraudFlags: result.fraudFlags,
      complianceChecks: result.complianceChecks,
      
      // Context information
      requestId: context.requestId,
      sourceIP: context.ip,
      deviceType: context.deviceType,
      
      // Timing information
      transactionStartTime: transaction.startTime,
      transactionEndTime: result.endTime,
      processingTime: result.endTime - transaction.startTime,
      
      // External dependencies
      externalServicesUsed: result.externalServices,
      thirdPartyApprovals: result.thirdPartyApprovals
    };
    
    if (result.success) {
      this.logger.info('Business transaction completed', transactionEvent);
    } else {
      this.logger.error('Business transaction failed', {
        ...transactionEvent,
        failureReason: result.failureReason,
        errorCode: result.errorCode
      });
    }
    
    // Compliance and audit alerts
    if (transaction.value > 10000 || result.fraudFlags.length > 0) {
      this.logger.warn('High-value or flagged transaction', {
        ...transactionEvent,
        requiresReview: true
      });
    }
  }
  
  logWorkflowAction(user, workflow, action, result, context) {
    const workflowActionEvent = {
      eventType: 'user_workflow_action',
      timestamp: new Date().toISOString(),
      
      // User context
      userId: user.id,
      userRole: user.role,
      
      // Workflow context
      workflowId: workflow.id,
      workflowInstanceId: workflow.instanceId,
      workflowStep: workflow.currentStep,
      
      // Action details
      actionType: action.type, // 'approve', 'reject', 'escalate', 'comment', 'reassign'
      actionReason: action.reason,
      actionComment: action.comment,
      
      // Decision context
      decisionCriteria: action.decisionCriteria,
      evidenceProvided: action.evidence,
      consultationsRequired: action.consultations,
      
      // Result information
      success: result.success,
      nextStep: result.nextStep,
      workflowStatus: result.workflowStatus,
      
      // Business impact
      businessImpact: action.businessImpact,
      customerImpact: action.customerImpact,
      financialImpact: action.financialImpact,
      
      // Context information
      requestId: context.requestId,
      sourceIP: context.ip,
      
      // Timing information
      actionTakenTime: action.timestamp,
      timeInQueue: action.timestamp - workflow.queuedTime,
      
      // Compliance
      auditRequired: action.auditRequired,
      complianceValidation: result.complianceValidation,
      approvalChain: workflow.approvalChain
    };
    
    this.logger.info('User workflow action', workflowActionEvent);
    
    // Alert on critical actions
    if (action.type === 'reject' || action.businessImpact === 'high') {
      this.logger.warn('Critical workflow action taken', workflowActionEvent);
    }
  }
}
```

## Best Practices for User Action Logging

### 1. **Privacy and Compliance**
- Hash or pseudonymize personally identifiable information
- Implement data retention policies
- Ensure GDPR, CCPA, and other privacy regulation compliance
- Provide user consent mechanisms where required

### 2. **Security Considerations**
- Never log passwords, API keys, or sensitive authentication data
- Implement log access controls
- Use correlation IDs to track user sessions securely
- Monitor for suspicious user behavior patterns

### 3. **Performance Impact**
- Use asynchronous logging for user actions
- Implement sampling for high-frequency actions
- Balance detail with system performance
- Consider user experience impact

### 4. **Analytics Value**
- Structure logs for easy analysis and reporting
- Include business context in user action logs
- Enable user journey reconstruction
- Support A/B testing and feature usage analysis

### 5. **Operational Excellence**
- Implement real-time monitoring for critical user actions
- Set up alerts for unusual user behavior
- Maintain comprehensive audit trails
- Enable efficient log search and analysis

---

**Previous**: [1.3.1 Application Events](./1.3.1_Application_Events.md)  
**Next**: [1.3.3 System Events](./1.3.3_System_Events.md)
